# Sets the docker image for the job
image: node:latest

# Sets the stages for the pipeline
stages:
  - test

# Cache the dependencies
cache:
  key: $CI_COMMIT_REF_SLUG-$CI_PROJECT_DIR
  paths:
    - .yarn

.cache-policy:
  cache:
    key: ${CI_COMMIT_SHORT_SHA}
    paths:
      - node_modules/
      - packages/client/node_modules/
      - packages/server/node_modules/

lerna bootstrap:
  extends: .cache-policy
  stage: install
  script:
    - yarn
    - yarn lerna bootstrap

#ðŸ‘‡Adds Chromatic as a job
chromatic_publish:
  stage: test
  script:
    - npx lerna --scope client run chromatic -- --auto-accept-changes --project-token=$CHROMATIC_PROJECT_TOKEN
  needs:
    - lerna bootstrap
